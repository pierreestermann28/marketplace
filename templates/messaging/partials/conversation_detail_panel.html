<div class="space-y-4">
  <div class="space-y-3">
    <div class="flex items-center justify-between">
      <h1 class="h2">Conversation</h1>
      <span class="text-sm text-ink-500">{{ conversation.listing.title }}</span>
    </div>
    <div class="card card-body p-3 flex items-center gap-3">
      <div class="relative w-20 h-20 overflow-hidden rounded-2xl bg-ink-50">
        {% with primary_image=conversation.listing.get_primary_image %}
          {% if primary_image and primary_image.image_asset.image.url %}
            <img src="{{ primary_image.image_asset.image.url }}"
                 alt="{{ conversation.listing.title }}"
                 class="w-full h-full object-cover" />
          {% else %}
            <div class="flex h-full w-full items-center justify-center text-[10px] uppercase tracking-[0.3em] text-ink-400">
              Aperçu
            </div>
          {% endif %}
        {% endwith %}
      </div>
      <div class="flex-1 flex flex-col gap-1 text-sm text-ink-600">
        <div class="flex items-center justify-between gap-2">
          <div class="text-base font-semibold text-ink-900 line-clamp-2">{{ conversation.listing.title }}</div>
          <div class="text-sm font-semibold text-ink-900">
            {% include "components/listings/listing_price.html" with cents=conversation.listing.price_cents currency=conversation.listing.currency only %}
          </div>
        </div>
        <div class="flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-ink-500">
          {% if conversation.listing.category %}<span class="badge">{{ conversation.listing.category.name }}</span>{% endif %}
          <span>{{ conversation.listing.city|default:"" }} {{ conversation.listing.postal_code|default:"" }}</span>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs text-ink-600">
          <span class="uppercase tracking-[0.2em]">{{ conversation.listing.get_condition_display }}</span>
          {% if conversation.listing.shipping_enabled %}<span class="badge-success">Expédition</span>{% endif %}
          {% if conversation.listing.in_person_enabled %}<span class="badge">Remise</span>{% endif %}
        </div>
        {% if conversation.listing.description %}
          <p class="text-xs text-ink-500 line-clamp-2">{{ conversation.listing.description }}</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="space-y-2">
    {% for message in conversation.messages.all %}
      <div class="flex {% if message.sender == request.user %}justify-end{% endif %}">
        <div class="max-w-3xl rounded-2xl border border-ink-100 p-3 shadow-sm {% if message.sender == request.user %}bg-brand text-white{% else %}bg-ink-50 text-ink-900{% endif %}">
          <div class="text-xs {% if message.sender == request.user %}text-white/80{% else %}text-ink-500{% endif %}">
            {{ message.sender.get_full_name|default:message.sender.username }} - {{ message.created_at|date:"d M Y H:i" }}
          </div>
          <p class="text-sm">
            {% if message.sender == request.user %}
              <span class="text-white">{{ message.text }}</span>
            {% else %}
              {{ message.text }}
            {% endif %}
          </p>
        </div>
      </div>
    {% empty %}
      <div class="rounded-xl border border-ink-100 p-4 text-sm text-ink-600">
        Envoie le premier message pour démarrer la discussion.
      </div>
    {% endfor %}
  </div>
  <form method="post"
        action="{% url 'messages:detail' conversation.pk %}"
        class="space-y-3"
        hx-post="{% url 'messages:detail' conversation.pk %}"
        hx-target="#conversation-detail"
        hx-swap="innerHTML"
        hx-on::afterSwap="if (window.lucide && window.lucide.createIcons) { window.lucide.createIcons(); }">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {{ form.text }}
    <div class="flex items-center justify-between">
      <button type="submit" class="btn btn-primary" aria-label="Envoyer le message">
        <i data-lucide="send" class="h-4 w-4" aria-hidden="true"></i>
      </button>
    </div>
  </form>
</div>
