{% extends "layouts/app.html" %}
{% block page_content %}
  <div class="container-app py-10" x-data="photoPicker()">
    <div class="mb-6">
      <h1 class="h1">Commencer par les photos</h1>
      <p class="muted mt-2 text-sm">L'IA propose un titre et une categorie a partir des images.</p>
    </div>

    <form method="post" enctype="multipart/form-data" class="card card-body grid gap-4">
      {% csrf_token %}
      {{ form.non_field_errors }}
      <div>
        <label class="label" for="id_images">Photos</label>
        <input class="input" type="file" name="images" id="id_images" multiple required @change="loadFiles($event)" />
        {{ form.images.errors }}
      </div>
      <input type="hidden" name="primary_index" :value="primaryIndex" />
      <div class="flex items-center justify-end">
        {% include "components/ui/button.html" with label="Continuer" variant="primary" type="submit" only %}
      </div>
    </form>

    <div class="mt-6">
      <div class="text-sm font-medium text-ink-900">Visuel principal</div>
      <div class="mt-3">
        <div class="aspect-[4/3] w-full overflow-hidden rounded-2xl border border-ink-100 bg-ink-50">
          <template x-if="previews.length">
            <img class="h-full w-full object-cover" :src="previews[primaryIndex]" alt="" />
          </template>
        </div>
      </div>

      <div class="mt-6">
        <div class="text-sm font-medium text-ink-900">Visuels secondaires</div>
        <div class="mt-3 grid grid-cols-2 gap-3 sm:grid-cols-3">
          <template x-for="(src, idx) in previews" :key="idx">
            <button type="button"
                    class="relative overflow-hidden rounded-xl border border-ink-100 bg-ink-50"
                    :class="idx === primaryIndex ? 'ring-2 ring-brand-700 ring-offset-2' : ''"
                    @click="primaryIndex = idx">
              <img class="h-32 w-full object-cover" :src="src" alt="" />
              <span class="absolute right-2 top-2 rounded-full bg-white/90 px-2 py-0.5 text-xs"
                    x-show="idx === primaryIndex">Principal</span>
            </button>
          </template>
        </div>
      </div>
    </div>
  </div>
  <script>
    function photoPicker() {
      return {
        previews: [],
        primaryIndex: 0,
        loadFiles(event) {
          const files = Array.from(event.target.files || []);
          this.previews = [];
          this.primaryIndex = 0;
          files.forEach((file) => {
            const reader = new FileReader();
            reader.onload = (e) => this.previews.push(e.target.result);
            reader.readAsDataURL(file);
          });
        },
      };
    }
  </script>
{% endblock %}
